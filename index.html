<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CWM Production System - v3.23 Auto-Remember</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-active { @apply border-b-4 border-blue-600 text-blue-600 font-bold bg-blue-50; }
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        .table-container { 
            @apply overflow-x-auto bg-white rounded-xl shadow mt-4 border border-gray-100; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 8px; 
        }
        .table-container::-webkit-scrollbar { height: 14px; }
        .table-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 8px; margin: 0 4px; }
        .table-container::-webkit-scrollbar-thumb { background-color: #64748b; border-radius: 8px; border: 3px solid #f1f5f9; }
        .table-container::-webkit-scrollbar-thumb:hover { background-color: #475569; }
        
        th { @apply px-8 py-4 bg-gray-50 text-left text-xs font-bold text-gray-600 uppercase border-b whitespace-nowrap tracking-wider; }
        td { @apply px-8 py-4 border-b text-sm text-gray-700 whitespace-nowrap; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .widget-card { background-color: #ffffff !important; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; height: 100%; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background-color: #f3f4f6; border: 2px dashed #cbd5e1; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans pb-10">
    <nav class="bg-white shadow-md sticky top-0 z-20">
        <div class="flex max-w-6xl mx-auto">
            <button onclick="switchTab('form')" id="tab-form" class="flex-1 py-4 text-center text-blue-600 font-bold border-b-4 border-blue-600">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏¥‡∏ï</button>
            <button onclick="switchTab('planning')" id="tab-planning" class="flex-1 py-4 text-center text-gray-500 hover:bg-gray-50">üìÖ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (Plan)</button>
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-4 text-center text-gray-500 hover:bg-gray-50">üìä Dashboard</button>
        </div>
    </nav>

    <!-- SECTION 1: PRODUCTION RECORD FORM (BATCH) -->
    <main id="section-form" class="max-w-4xl mx-auto p-4 space-y-4">
        <div class="bg-white rounded-xl shadow-lg p-4 border-t-4 border-blue-500">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-lg font-bold text-gray-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Batch)</h1>
                <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">v3.23 Auto-Save</span>
            </div>
            
            <form id="productionForm" class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-blue-800 mb-1">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="productionDate" name="productionDate" required class="w-full p-2 border rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-blue-800 mb-1">üë§ ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                        <div class="flex gap-1">
                            <input list="recorder-datalist" id="recorder" name="recorder" class="w-full p-2 border rounded text-sm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..." required autocomplete="off">
                            <datalist id="recorder-datalist"></datalist>
                            <button type="button" onclick="manageRecorders()" class="bg-white border border-blue-300 text-blue-600 px-2 rounded hover:bg-blue-50">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-blue-800 mb-1">‡∏Å‡∏∞</label>
                         <div class="flex items-center gap-2">
                            <select id="shift" name="shift" class="w-20 p-2 border rounded text-sm"><option value="A">A</option><option value="B">B</option></select>
                            <div class="flex flex-col text-[10px]">
                                <label><input type="radio" name="shift_type_toggle" value="Day" onclick="updateHourSlots('Day')"> ‡πÄ‡∏ä‡πâ‡∏≤</label>
                                <label><input type="radio" name="shift_type_toggle" value="Night" onclick="updateHourSlots('Night')"> ‡∏î‡∏∂‡∏Å</label>
                            </div>
                         </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-blue-800 mb-1">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <select id="hourSlot" name="hourSlot" required class="w-full p-2 border rounded text-sm"></select>
                    </div>
                </div>

                <div id="batchList" class="space-y-3"></div>
                
                <button type="button" onclick="addBatchRow()" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 font-bold hover:border-blue-400 hover:text-blue-500">
                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Add Model/Machine)
                </button>

                <hr class="border-gray-200">

                <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </form>
        </div>
    </main>

    <!-- SECTION 2: PLANNING FORM -->
    <main id="section-planning" class="max-w-2xl mx-auto p-4 space-y-4 hidden">
        <div class="bg-white rounded-xl shadow-lg p-4 border-t-4 border-indigo-500">
            <h1 class="text-lg font-bold text-gray-800 mb-4">üìÖ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h1>
            <form id="planningForm" class="space-y-4">
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 grid gap-4">
                    <input type="date" id="planDate" name="planDate" required class="w-full p-3 border rounded-lg">
                    <select id="planProduct" name="planProduct" required class="w-full p-3 border rounded-lg"></select>
                    <div class="grid grid-cols-2 gap-4">
                         <select id="planShift" name="planShift" class="p-3 border rounded-lg">
                             <option value="All">All Shifts</option><option value="A">A</option><option value="B">B</option>
                         </select>
                         <input type="number" id="planQty" name="planQty" placeholder="Target Qty" class="p-3 border rounded-lg text-center font-bold">
                    </div>
                </div>
                <button type="submit" id="planSubmitBtn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô</button>
            </form>
        </div>
    </main>

    <!-- SECTION 3: DASHBOARD -->
    <main id="section-dashboard" class="max-w-6xl mx-auto p-4 space-y-6 hidden">
        <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-indigo-500">
            <h2 class="text-gray-700 font-bold text-sm mb-3">üìÖ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</h2>
            <div class="flex flex-col md:flex-row gap-3 items-end">
                <input type="date" id="startDate" class="w-full md:w-auto p-2 border rounded text-sm">
                <input type="date" id="endDate" class="w-full md:w-auto p-2 border rounded text-sm">
                <select id="filterShift" class="w-full md:w-auto p-2 border rounded text-sm"><option value="All">All Shift</option><option value="A">A</option><option value="B">B</option></select>
                <select id="filterShiftType" class="w-full md:w-auto p-2 border rounded text-sm"><option value="All">All Type</option><option value="Day">Day</option><option value="Night">Night</option></select>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="loadDashboard()" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    <button onclick="toggleLayout()" id="layoutBtn" class="flex-1 bg-white text-indigo-600 border border-indigo-200 px-4 py-2 rounded text-sm font-bold">üîÄ Layout: ‡∏Ñ‡∏π‡πà</button>
                </div>
            </div>
        </div>

        <div id="dashboard-loader" class="hidden text-center py-10"><div class="loader mx-auto"></div><p>Loading...</p></div>

        <div id="dashboard-content" class="space-y-6 pb-20">
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="widget-card p-4 border-l-4 border-indigo-500">
                    <p class="text-xs text-gray-400 font-bold">TARGET (PLAN)</p>
                    <p id="stat-target" class="text-2xl font-bold text-indigo-600">0</p>
                </div>
                <div class="widget-card p-4 border-l-4 border-blue-500">
                    <p class="text-xs text-gray-400 font-bold">TOTAL FG</p>
                    <p id="stat-fg" class="text-2xl font-bold text-blue-600">0</p>
                </div>
                <div class="widget-card p-4 border-l-4 border-orange-500">
                    <p class="text-xs text-gray-400 font-bold">% ACH</p>
                    <p id="stat-achievement" class="text-2xl font-bold text-orange-600">0%</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2"><div id="progress-achievement" class="bg-orange-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                </div>
                <div class="widget-card p-4 border-l-4 border-red-500">
                    <p class="text-xs text-gray-400 font-bold">TOTAL NG (Kg)</p>
                    <p id="stat-ng" class="text-2xl font-bold text-red-600">0.00</p>
                </div>
                <div class="widget-card p-4 border-l-4 border-green-500">
                    <p class="text-xs text-gray-400 font-bold">% YIELD</p>
                    <p id="stat-yield" class="text-2xl font-bold text-green-600">0%</p>
                </div>
                <div class="widget-card p-4 border-l-4 border-teal-500">
                    <p class="text-xs text-gray-400 font-bold">UPH</p>
                    <p id="stat-uph" class="text-2xl font-bold text-teal-600">0</p>
                </div>
            </div>

            <!-- Charts -->
            <div id="sortable-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="widget-card p-4 h-80">
                    <div class="widget-header drag-handle mb-2"><h3 class="font-bold text-gray-700 text-sm">üìâ NG Analysis (Pareto)</h3><button onclick="toggleCardSize(this)" class="text-gray-400 hover:text-gray-600">‚Üî</button></div>
                    <div class="flex-1"><canvas id="paretoChart"></canvas></div>
                </div>
                <div class="widget-card p-4 h-80">
                    <div class="widget-header drag-handle mb-2"><h3 class="font-bold text-gray-700 text-sm">üìâ Daily NG Trend</h3><button onclick="toggleCardSize(this)" class="text-gray-400 hover:text-gray-600">‚Üî</button></div>
                    <div class="flex-1"><canvas id="qcTrendChart"></canvas></div>
                </div>
                <div class="widget-card p-4 h-64">
                    <div class="widget-header drag-handle mb-2"><h3 class="font-bold text-gray-700 text-sm">% Yield by Model</h3><button onclick="toggleCardSize(this)" class="text-gray-400 hover:text-gray-600">‚Üî</button></div>
                    <div class="flex-1"><canvas id="yieldModelChart"></canvas></div>
                </div>
                <div class="widget-card p-4 h-64">
                    <div class="widget-header drag-handle mb-2"><h3 class="font-bold text-gray-700 text-sm">% Yield by Machine</h3><button onclick="toggleCardSize(this)" class="text-gray-400 hover:text-gray-600">‚Üî</button></div>
                    <div class="flex-1"><canvas id="yieldMachineChart"></canvas></div>
                </div>
                <div class="widget-card p-4 h-80">
                    <div class="widget-header drag-handle mb-2"><h3 class="font-bold text-gray-700 text-sm">Hourly Production</h3><button onclick="toggleCardSize(this)" class="text-gray-400 hover:text-gray-600">‚Üî</button></div>
                    <div class="flex-1"><canvas id="hourlyChart"></canvas></div>
                </div>
                <div class="widget-card p-4 h-80">
                    <div class="widget-header drag-handle mb-2"><h3 class="font-bold text-gray-700 text-sm">NG Breakdown</h3><button onclick="toggleCardSize(this)" class="text-gray-400 hover:text-gray-600">‚Üî</button></div>
                    <div class="flex-1"><canvas id="ngChart"></canvas></div>
                </div>
                <div class="widget-card md:col-span-2 p-4">
                    <div class="widget-header drag-handle mb-2"><h3 class="font-bold text-gray-700 text-sm">Detailed Machine Performance</h3><button onclick="toggleCardSize(this)" class="text-gray-400 hover:text-gray-600">‚Üî</button></div>
                    <div class="table-container">
                        <table class="w-full min-w-[1200px] divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr id="table-header"><th>Machine</th><th>FG</th><th>NG (Kg)</th><th>% Yield</th></tr></thead>
                            <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- NG MODAL -->
    <div id="modal-ng" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-4 flex flex-col max-h-[80vh]">
            <h3 class="text-lg font-bold mb-4 flex-none">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ (NG)</h3>
            <div id="modal-ng-list" class="space-y-2 mb-4 overflow-y-auto flex-1 p-1"></div>
            <div class="flex-none pt-2 border-t">
                 <button type="button" onclick="addCustomNgField()" class="w-full mb-2 text-blue-600 text-xs font-bold border border-blue-200 rounded py-1 hover:bg-blue-50">+ ‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô (Add Other)</button>
                 <div class="flex gap-2">
                    <button onclick="closeNgModal(true)" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="closeNgModal(false)" class="flex-1 bg-gray-200 py-2 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- Machine Detail Modal -->
    <div id="modal-machine-detail" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden backdrop-blur-sm p-2">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden animate-fade-in flex flex-col max-h-[90vh]">
            <div class="bg-blue-600 p-4 border-b flex justify-between items-center text-white">
                <h3 id="machine-detail-title" class="font-bold text-lg">Machine Detail</h3>
                <button onclick="document.getElementById('modal-machine-detail').classList.add('hidden')" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div class="h-64 md:h-80 w-full"><canvas id="machineDetailChart"></canvas></div>
                <div id="machine-detail-stats" class="mt-4 grid grid-cols-2 gap-4 text-center"></div>
                <div id="machine-detail-remarks" class="mt-4 border-t pt-2 hidden">
                    <h4 class="font-bold text-gray-700 text-left">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ (NG Remarks)</h4>
                    <div id="machine-remarks-list" class="text-left text-sm text-gray-600 mt-2 max-h-32 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for Managing Lists -->
    <div id="modal-manage-list" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-4 flex flex-col max-h-[80vh]">
            <h3 id="manage-list-title" class="text-lg font-bold mb-4 flex-none">Manage List</h3>
            <div id="manage-list-content" class="space-y-2 mb-4 overflow-y-auto flex-1 p-1"></div>
            <div class="flex-none pt-2 border-t flex gap-2">
                 <input type="text" id="new-item-input" class="flex-1 p-2 border rounded text-sm" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà...">
                 <button onclick="addNewItemToList()" class="bg-green-600 text-white px-4 rounded font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            <button onclick="closeManageListModal()" class="mt-2 w-full bg-gray-200 py-2 rounded font-bold">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyt3Bf_2h21BBcCHQSjizowy_kD5vsoUqgaC_YmVjLuQybJO1BBRt3eaSM0PuKEFfvruw/exec";
        
        let ngSymptoms = ["‡∏•‡∏ß‡∏î‡∏ñ‡∏•‡∏≠‡∏Å (Scratched)", "‡∏û‡∏±‡∏ô‡∏´‡∏•‡∏ß‡∏° (Loose)", "‡∏£‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (Turn Error)", "‡∏Ç‡∏≤‡∏ú‡∏¥‡∏î‡∏£‡∏π‡∏õ (Lead Deform)", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Others)"];
        let productList = ["S1B29288-JR (10A)", "S1B71819-JR (16A)", "S1B29292-JR (20A)", "51207080HC-JR (25/32A)"];
        let recorderList = ["‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 1", "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 2"];
        
        const DAY_HOURS = ["08:00-09:00", "09:00-10:00", "10:00-11:00", "11:00-12:00", "12:00-13:00", "13:00-14:00", "14:00-15:00", "15:00-16:00", "16:00-17:00", "OT 17:30-18:00", "OT 18:00-19:00", "OT 19:00-20:00"];
        const NIGHT_HOURS = ["20:00-21:00", "21:00-22:00", "22:00-23:00", "23:00-00:00", "00:00-01:00", "01:00-02:00", "02:00-03:00", "03:00-04:00", "04:00-05:00", "OT 05:00-06:30", "OT 06:00-07:30", "OT 07:00-08:00"];

        let currentRowIdForNg = null;
        let batchNgData = {};
        let currentDashboardData = null;
        let dailyTarget = 0;
        let machineDetailChart = null;
        let charts = {};
        let currentManageType = ''; // 'recorder' or 'symptom'

        // Register Plugin
        try { Chart.register(ChartDataLabels); } catch(e) { console.warn("ChartDataLabels not loaded"); }

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('productionDate').value = today;
            document.getElementById('planDate').value = today;
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;

            // Load from LocalStorage
            if(localStorage.getItem('CWM_CUSTOM_NG')) ngSymptoms = JSON.parse(localStorage.getItem('CWM_CUSTOM_NG'));
            if(localStorage.getItem('CWM_RECORDERS')) recorderList = JSON.parse(localStorage.getItem('CWM_RECORDERS'));

            detectCurrentShift();
            addBatchRow();
            fetchOptions();
            initSortable();
            renderRecorderOptions();
            renderProductOptions();

            if(window.location.hash === '#dashboard') switchTab('dashboard');
            else switchTab('form');
        };
        
        async function fetchOptions() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=GET_OPTIONS`);
                const data = await res.json();
                
                // Merge Recorders
                const allRecorders = new Set([...recorderList, ...data.recorders]);
                recorderList = Array.from(allRecorders);
                renderRecorderOptions();

                // Merge NG Types
                if (data.ngTypes && data.ngTypes.length > 0) {
                   const newSet = new Set([...ngSymptoms, ...data.ngTypes]);
                   ngSymptoms = Array.from(newSet);
                }
            } catch (e) { console.log("Offline or Error fetching options", e); }
        }

        // --- Layout ---
        function initSortable() {
            const grid = document.getElementById('sortable-grid');
            Sortable.create(grid, { handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost', onEnd: function() { Object.values(charts).forEach(c => { if(c) c.resize(); }); } });
        }
        function toggleCardSize(btn) {
            const card = btn.closest('.widget-card');
            if (card.classList.contains('md:col-span-2')) card.classList.remove('md:col-span-2'); else card.classList.add('md:col-span-2');
            const canvas = card.querySelector('canvas');
            if(canvas) { const chartInstance = Chart.getChart(canvas); if(chartInstance) chartInstance.resize(); }
        }

        // --- Common Logic ---
        function detectCurrentShift() {
            const hour = new Date().getHours();
            let type = (hour >= 8 && hour < 20) ? "Day" : "Night";
            document.querySelector(`input[name="shift_type_toggle"][value="${type}"]`).checked = true;
            updateHourSlots(type);
        }
        function updateHourSlots(type) {
            const select = document.getElementById('hourSlot');
            const hours = (type === "Day") ? DAY_HOURS : NIGHT_HOURS;
            select.innerHTML = hours.map(h => `<option value="${h}">${h}</option>`).join('');
            const currentHourStr = new Date().getHours().toString().padStart(2, '0') + ":00";
            const match = hours.find(h => h.startsWith(currentHourStr));
            if(match) select.value = match;
        }
        
        function switchTab(tab) {
            ['form', 'planning', 'dashboard'].forEach(t => {
                document.getElementById('section-'+t).classList.toggle('hidden', t !== tab);
                const btn = document.getElementById('tab-'+t);
                if(t === tab) { btn.classList.add('tab-active','text-blue-600'); btn.classList.remove('text-gray-500'); }
                else { btn.classList.remove('tab-active','text-blue-600'); btn.classList.add('text-gray-500'); }
            });
            if(tab==='dashboard') loadDashboard();
        }

        // --- Batch Row ---
        function addBatchRow() {
            const container = document.getElementById('batchList');
            const rowId = 'row-' + Date.now() + Math.random().toString(36).substr(2, 5);
            let machineOpts = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á...</option>';
            for(let i=1; i<=16; i++) machineOpts += `<option value="CWM-${String(i).padStart(2,'0')}">CWM-${String(i).padStart(2,'0')}</option>`;
            let prodOpts = productList.map(p => `<option value="${p}">${p}</option>`).join('');

            const div = document.createElement('div');
            div.id = rowId;
            div.className = "bg-white p-3 border border-gray-200 rounded-lg shadow-sm flex flex-col md:flex-row gap-3 items-end md:items-center";
            div.innerHTML = `
                <div class="flex-1 w-full"><label class="text-[10px] text-gray-400 font-bold uppercase">Machine</label><select name="machine" class="w-full p-2 border rounded bg-gray-50 text-sm font-bold">${machineOpts}</select></div>
                <div class="flex-1 w-full"><label class="text-[10px] text-gray-400 font-bold uppercase">Product</label><select name="productCode" class="w-full p-2 border rounded bg-gray-50 text-sm">${prodOpts}</select></div>
                <div class="w-24"><label class="text-[10px] text-gray-400 font-bold uppercase">FG</label><input type="number" name="fgAmount" value="1000" class="w-full p-2 border rounded text-center font-bold text-green-600 bg-green-50 focus:bg-white" min="0"></div>
                <div class="w-full md:w-auto flex gap-2">
                    <button type="button" onclick="openNgModal('${rowId}')" class="flex-1 md:flex-none bg-red-50 text-red-600 border border-red-200 px-3 py-2 rounded font-bold text-sm hover:bg-red-100 relative">NG (Kg) <span id="ng-badge-${rowId}" class="hidden absolute -top-2 -right-2 bg-red-600 text-white text-[10px] px-1.5 py-0.5 rounded-full">0</span></button>
                    <button type="button" onclick="removeBatchRow('${rowId}')" class="text-gray-400 hover:text-red-500 px-2 text-xl">&times;</button>
                </div>
            `;
            container.appendChild(div);
            batchNgData[rowId] = [];
        }

        function removeBatchRow(id) { document.getElementById(id).remove(); delete batchNgData[id]; }

        // --- NG Modal ---
        function openNgModal(rowId) {
            currentRowIdForNg = rowId;
            const modal = document.getElementById('modal-ng');
            const list = document.getElementById('modal-ng-list');
            list.innerHTML = '';
            
            ngSymptoms.forEach(s => {
                const existing = batchNgData[rowId].find(x => x.type === s);
                const val = existing ? existing.qty : '';
                const remark = existing ? existing.remark : '';
                renderNgItem(list, s, val, remark);
            });
            const customItems = batchNgData[rowId].filter(x => !ngSymptoms.includes(x.type));
            customItems.forEach(item => { renderNgItem(list, item.type, item.qty, item.remark, true); });
            modal.classList.remove('hidden');
        }

        function renderNgItem(container, label, qty, remark, isCustom=false) {
            const div = document.createElement('div');
            div.className = "border-b pb-2 mb-2 ng-item-row";
            const typeInput = isCustom ? `<input type="text" class="ng-type-name w-full p-1 border rounded text-sm font-bold text-red-700 mb-1" value="${label}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£...">` : `<span class="text-sm font-medium text-gray-700 ng-type-label" data-label="${label}">${label}</span>`;
            div.innerHTML = `<div class="flex justify-between items-center mb-1"><div class="flex-1">${typeInput}</div><div class="flex items-center ml-2"><input type="number" class="ng-input-qty w-20 p-1 border rounded text-right" value="${qty}" placeholder="0.00" min="0" step="0.01"><span class="text-xs text-gray-500 ml-1">Kg</span></div></div><input type="text" class="ng-input-remark w-full p-1 border rounded text-xs bg-gray-50" value="${remark}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">`;
            container.appendChild(div);
        }

        function addCustomNgField() { const list = document.getElementById('modal-ng-list'); renderNgItem(list, "", "", "", true); list.scrollTop = list.scrollHeight; }

        function closeNgModal(save) {
            if(save && currentRowIdForNg) {
                const rows = document.querySelectorAll('.ng-item-row');
                const newData = [];
                let total = 0;
                rows.forEach(row => {
                    let type = "";
                    const labelSpan = row.querySelector('.ng-type-label');
                    const nameInput = row.querySelector('.ng-type-name');
                    if (labelSpan) type = labelSpan.dataset.label; else if (nameInput) type = nameInput.value.trim();
                    const qty = parseFloat(row.querySelector('.ng-input-qty').value);
                    const remark = row.querySelector('.ng-input-remark').value;
                    if (type && qty > 0) { newData.push({ type, qty, remark }); total += qty; }
                });
                batchNgData[currentRowIdForNg] = newData;
                const badge = document.getElementById(`ng-badge-${currentRowIdForNg}`);
                if(total > 0) { badge.innerText = total.toFixed(2); badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
            }
            document.getElementById('modal-ng').classList.add('hidden');
            currentRowIdForNg = null;
        }

        // --- Recorders & List Mgmt ---
        function renderRecorderOptions() { 
            const datalist = document.getElementById('recorder-datalist'); 
            datalist.innerHTML = '';
            recorderList.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                datalist.appendChild(opt);
            });
        }
        function renderProductOptions() { const s = document.getElementById('planProduct'); if(s) s.innerHTML = productList.map(p=>`<option value="${p}">${p}</option>`).join(''); }

        function manageRecorders() {
            currentManageType = 'recorder';
            openManageListModal('‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', recorderList);
        }
        function manageSymptoms() {
            currentManageType = 'symptom';
            openManageListModal('‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ NG', ngSymptoms);
        }

        function openManageListModal(title, list) {
             const modal = document.getElementById('modal-manage-list');
             document.getElementById('manage-list-title').innerText = title;
             renderManageListContent(list);
             modal.classList.remove('hidden');
        }

        function renderManageListContent(list) {
             const container = document.getElementById('manage-list-content');
             container.innerHTML = list.map((item, i) => `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded mb-1">
                    <span class="text-sm">${item}</span>
                    <button onclick="deleteListItem(${i})" class="text-red-500 hover:bg-red-100 p-1 rounded">üóëÔ∏è</button>
                </div>
             `).join('');
        }

        function addNewItemToList() {
             const val = document.getElementById('new-item-input').value.trim();
             if(!val) return;
             if (currentManageType === 'recorder') {
                 if (!recorderList.includes(val)) {
                     recorderList.push(val);
                     localStorage.setItem('CWM_RECORDERS', JSON.stringify(recorderList));
                     renderRecorderOptions();
                     renderManageListContent(recorderList);
                 }
             } else if (currentManageType === 'symptom') {
                 if (!ngSymptoms.includes(val)) {
                     ngSymptoms.push(val);
                     localStorage.setItem('CWM_CUSTOM_NG', JSON.stringify(ngSymptoms));
                     renderManageListContent(ngSymptoms);
                 }
             }
             document.getElementById('new-item-input').value = '';
        }

        function deleteListItem(index) {
             if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;
             if (currentManageType === 'recorder') {
                 recorderList.splice(index, 1);
                 localStorage.setItem('CWM_RECORDERS', JSON.stringify(recorderList));
                 renderRecorderOptions();
                 renderManageListContent(recorderList);
             } else if (currentManageType === 'symptom') {
                 ngSymptoms.splice(index, 1);
                 localStorage.setItem('CWM_CUSTOM_NG', JSON.stringify(ngSymptoms));
                 renderManageListContent(ngSymptoms);
             }
        }
        function closeManageListModal() { document.getElementById('modal-manage-list').classList.add('hidden'); }

        // --- Submit Production ---
        document.getElementById('productionForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn'); const txt = btn.innerText;
            btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            
            const fd = new FormData(e.target);
            const shiftType = document.querySelector('input[name="shift_type_toggle"]:checked').value;
            
            // Auto-save Recorder
            const currentRec = fd.get('recorder');
            if(currentRec && !recorderList.includes(currentRec)) {
                 recorderList.push(currentRec);
                 localStorage.setItem('CWM_RECORDERS', JSON.stringify(recorderList));
                 renderRecorderOptions();
            }

            const common = {
                timestamp: new Date().toLocaleString('th-TH'),
                productionDate: fd.get('productionDate'),
                shift: fd.get('shift'), shiftType: shiftType,
                recorder: currentRec, hourSlot: fd.get('hourSlot')
            };

            const items = [];
            const rowDivs = document.getElementById('batchList').children;
            
            // Auto-save NG
            let newNgTypes = [];
            
            for(let div of rowDivs) {
                const machine = div.querySelector('[name="machine"]').value;
                const product = div.querySelector('[name="productCode"]').value;
                const fg = parseInt(div.querySelector('[name="fgAmount"]').value) || 0;
                
                if(!machine) continue;
                
                const ngDetails = batchNgData[div.id] || [];
                ngDetails.forEach(ng => {
                    if (ng.type && !ngSymptoms.includes(ng.type) && !newNgTypes.includes(ng.type)) {
                        newNgTypes.push(ng.type);
                    }
                });

                items.push({ machine, productCode: product, fgAmount: fg, ngDetails });
            }

            if(newNgTypes.length > 0) {
                ngSymptoms = [...ngSymptoms, ...newNgTypes];
                localStorage.setItem('CWM_CUSTOM_NG', JSON.stringify(ngSymptoms));
            }

            if(items.length === 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"); btn.disabled = false; btn.innerText = txt; return; }

            const payload = { action: 'SAVE_BATCH_PRODUCTION', common, items };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                document.getElementById('batchList').innerHTML = ''; batchNgData = {}; addBatchRow();
            } catch(e) { alert("Error: " + e.message); } finally { btn.disabled = false; btn.innerText = txt; }
        };

        // --- Submit Plan ---
        document.getElementById('planningForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = { action: 'SAVE_PLAN', planDate: fd.get('planDate'), product: fd.get('planProduct'), shift: fd.get('planShift'), qty: fd.get('planQty') };
            await fetch(SCRIPT_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(payload)}); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); e.target.reset();
            document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
        };

        // --- Dashboard Logic ---
        async function loadDashboard() {
            if(!SCRIPT_URL) return;
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('dashboard-loader').classList.remove('hidden');
            const start = document.getElementById('startDate').value; const end = document.getElementById('endDate').value;
            const shift = document.getElementById('filterShift').value; const shiftType = document.getElementById('filterShiftType').value;
            try {
                const res = await fetch(`${SCRIPT_URL}?action=GET_DASHBOARD&start=${start}&end=${end}&shift=${shift}&shiftType=${shiftType}`);
                const data = await res.json();
                
                document.getElementById('stat-fg').innerText = data.totalFg.toLocaleString();
                document.getElementById('stat-ng').innerText = data.totalNg.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('stat-target').innerText = (data.productionTarget||0).toLocaleString();
                
                const ach = data.productionTarget>0 ? ((data.totalFg/data.productionTarget)*100).toFixed(1) : 0;
                document.getElementById('stat-achievement').innerText = ach+"%";
                document.getElementById('progress-achievement').style.width = Math.min(ach,100)+"%";
                
                const total = data.totalFg + data.totalNg;
                const yieldVal = total>0?((data.totalFg/total)*100).toFixed(2):0;
                document.getElementById('stat-yield').innerText = yieldVal+"%";
                
                // UPH
                let activeHours = 0; if(data.hourlyData) activeHours = data.hourlyData.filter(v => v > 0).length;
                if(activeHours === 0) activeHours = 1;
                const uph = (data.totalFg / activeHours).toFixed(0);
                document.getElementById('stat-uph').innerText = uph;

                currentDashboardData = data;
                renderCharts(data); renderTable(data);
            } catch(e) { console.error(e); } 
            finally { document.getElementById('dashboard-loader').classList.add('hidden'); document.getElementById('dashboard-content').classList.remove('hidden'); }
        }

        // Charts & Table Renderers
        function renderCharts(data) {
             if(!charts) charts = {};
             const commonOpts = { responsive: true, maintainAspectRatio: false };

             // Pareto
             const ctxP = document.getElementById('paretoChart');
             if(ctxP) {
                 if(charts.pareto) charts.pareto.destroy();
                 const ngItems = data.ngLabels.map((l, i) => ({ label: l, value: data.ngValues[i] })).sort((a,b)=>b.value-a.value);
                 const totalNG = ngItems.reduce((a,b)=>a+b.value,0);
                 let acc = 0; const cumulative = ngItems.map(i=>{ acc+=i.value; return totalNG>0?((acc/totalNG)*100).toFixed(1):0; });
                 
                 charts.pareto = new Chart(ctxP, { 
                     type: 'bar', plugins: [ChartDataLabels],
                     data: { 
                         labels: ngItems.map(i=>i.label), 
                         datasets: [
                             { label: '% ‡∏™‡∏∞‡∏™‡∏°', data: cumulative, type: 'line', borderColor: '#8b5cf6', yAxisID: 'y1', datalabels: { display: false } },
                             { label: 'NG (Kg)', data: ngItems.map(i=>i.value), backgroundColor: '#ef4444', yAxisID: 'y', datalabels: { align: 'end', anchor: 'end', formatter: (v) => v.toFixed(2) } }
                         ]
                     },
                     options: { ...commonOpts, layout: { padding: { top: 20 } }, scales: { y: { beginAtZero: true, grace: '10%' }, y1: { beginAtZero: true, max: 105, position: 'right', grid: { display: false } } } }
                 });
             }

             // Hourly
             const ctxH = document.getElementById('hourlyChart');
             if(ctxH) {
                 if(charts.hourly) charts.hourly.destroy();
                 charts.hourly = new Chart(ctxH, { type: 'bar', data: { labels: data.hourlyLabels, datasets: [{label:'FG', data:data.hourlyData, backgroundColor:'#3b82f6'}, {label:'NG (Kg)', data:data.hourlyNgData, backgroundColor:'#ef4444'}] }, options: {...commonOpts, scales:{x:{stacked:true}, y:{stacked:true}}} });
             }

             // Yield Machine
             const ctxYieldM = document.getElementById('yieldMachineChart');
             if(ctxYieldM) {
                if(charts.yieldMachine) charts.yieldMachine.destroy();
                const macs = []; for(let i=1;i<=16;i++) macs.push(`CWM-${String(i).padStart(2,'0')}`);
                charts.yieldMachine = new Chart(ctxYieldM, { type: 'bar', data: { labels: macs, datasets: [{ label: '% Yield', data: macs.map(m=>{const d=data.machineData[m]; if(!d)return 0; const t=d.fg+d.ngTotal; return t>0?((d.fg/t)*100).toFixed(1):0}), backgroundColor: '#6366f1' }] }, options: {...commonOpts, scales:{y:{max:100}}} });
             }

             // QC Trend
             const ctxQC = document.getElementById('qcTrendChart');
             if(ctxQC) {
                if(charts.qcTrend) charts.qcTrend.destroy();
                 const trendData = data.dailyTrend || [];
                 charts.qcTrend = new Chart(ctxQC, { type: 'line', data: { labels: trendData.map(d=>d.date), datasets: [{label:'% NG Rate', data:trendData.map(d=>d.ngRate), borderColor:'#f97316'}] }, options: commonOpts });
             }
             
             // NG Pie
             const ctxNG = document.getElementById('ngChart');
             if(ctxNG) {
                if(charts.ng) charts.ng.destroy();
                charts.ng = new Chart(ctxNG, { type: 'doughnut', data: { labels: data.ngLabels, datasets: [{ data: data.ngValues, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4'] }] }, options: commonOpts });
             }

             // Yield Model
             const ctxYM = document.getElementById('yieldModelChart');
             if(ctxYM) {
                 if(charts.yieldModel) charts.yieldModel.destroy();
                 charts.yieldModel = new Chart(ctxYM, { type: 'bar', data: { labels: Object.keys(data.productData), datasets: [{ label: '% Yield', data: Object.values(data.productData).map(d => {const t=d.fg+d.ngTotal; return t>0?((d.fg/t)*100).toFixed(1):0}), backgroundColor: '#10b981' }] }, options: {...commonOpts, indexAxis:'y'} });
             }
        }

        function renderTable(data) {
            const b = document.getElementById('table-body'); b.innerHTML = '';
            for(let i=1; i<=16; i++) {
                const m = `CWM-${String(i).padStart(2,'0')}`; 
                const d = data.machineData[m] || {fg:0, ngTotal:0};
                const t = d.fg + d.ngTotal; 
                const y = t > 0 ? ((d.fg/t)*100).toFixed(1) : "0.0";
                
                let html = `<td class="p-4 border-b font-bold cursor-pointer text-blue-600 hover:underline" onclick="showMachineDetail('${m}')">üëâ ${m}</td>
                    <td class="p-4 border-b">${d.fg}</td>
                    <td class="p-4 border-b text-red-600 font-bold">${d.ngTotal.toFixed(2)}</td>
                    <td class="p-4 border-b">${y}%</td>`;
                b.innerHTML += `<tr>${html}</tr>`;
            }
        }

        function showMachineDetail(machineName) {
            if(!currentDashboardData) return;
            const modal = document.getElementById('modal-machine-detail');
            const mData = currentDashboardData.machineData[machineName] || { fg: 0, ngTotal: 0, hourlyFg: [], hourlyNg: [], remarks: [] };
            document.getElementById('machine-detail-title').innerText = `üìä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machineName}`;
            document.getElementById('machine-detail-stats').innerHTML = `<div class="bg-blue-50 p-2 rounded">FG ‡∏£‡∏ß‡∏°: <b class="text-blue-700 text-xl">${mData.fg}</b></div><div class="bg-red-50 p-2 rounded">NG ‡∏£‡∏ß‡∏°: <b class="text-red-700 text-xl">${mData.ngTotal.toFixed(2)}</b></div>`;
            
            const rList = document.getElementById('machine-remarks-list');
            const rSec = document.getElementById('machine-detail-remarks');
            if(mData.remarks && mData.remarks.length > 0) { 
                rSec.classList.remove('hidden'); 
                rList.innerHTML = `<ul class="list-disc pl-5 space-y-1">${mData.remarks.map(r => `<li>${r}</li>`).join('')}</ul>`; 
            } else { 
                rSec.classList.add('hidden'); 
            }
            
            modal.classList.remove('hidden');
            if(machineDetailChart) machineDetailChart.destroy();
            machineDetailChart = new Chart(document.getElementById('machineDetailChart').getContext('2d'), { type: 'bar', data: { labels: currentDashboardData.hourlyLabels, datasets: [{ label: 'FG (‡∏á‡∏≤‡∏ô‡∏î‡∏µ)', data: mData.hourlyFg, backgroundColor: '#3b82f6', borderRadius: 2 }, { label: 'NG (‡πÄ‡∏™‡∏µ‡∏¢)', data: mData.hourlyNg || [], backgroundColor: '#ef4444', borderRadius: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true }, zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } } }, scales: { x: { stacked: true }, y: { beginAtZero: true, stacked: true } } } });
        }
    </script>
</body>
</html>
