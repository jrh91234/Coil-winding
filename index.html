<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CWM Production System - v3.19 Batch Entry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-active { @apply border-b-4 border-blue-600 text-blue-600 font-bold bg-blue-50; }
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        .table-container { 
            @apply overflow-x-auto bg-white rounded-xl shadow mt-4 border border-gray-100; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 8px; 
        }
        .table-container::-webkit-scrollbar { height: 14px; }
        .table-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 8px; margin: 0 4px; }
        .table-container::-webkit-scrollbar-thumb { background-color: #64748b; border-radius: 8px; border: 3px solid #f1f5f9; }
        .table-container::-webkit-scrollbar-thumb:hover { background-color: #475569; }
        
        th { @apply px-8 py-4 bg-gray-50 text-left text-xs font-bold text-gray-600 uppercase border-b whitespace-nowrap tracking-wider; }
        td { @apply px-8 py-4 border-b text-sm text-gray-700 whitespace-nowrap; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Force White Background on Cards */
        .widget-card { background-color: #ffffff !important; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; height: 100%; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans pb-10">
    <nav class="bg-white shadow-md sticky top-0 z-20">
        <div class="flex max-w-6xl mx-auto">
            <button onclick="switchTab('form')" id="tab-form" class="flex-1 py-4 text-center tab-active text-sm md:text-base transition-colors">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏¥‡∏ï</button>
            <button onclick="switchTab('planning')" id="tab-planning" class="flex-1 py-4 text-center text-gray-500 text-sm md:text-base hover:bg-gray-50 transition-colors">üìÖ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (Plan)</button>
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-4 text-center text-gray-500 text-sm md:text-base hover:bg-gray-50 transition-colors">üìä Dashboard</button>
        </div>
    </nav>

    <!-- SECTION 1: PRODUCTION RECORD FORM (BATCH) -->
    <main id="section-form" class="max-w-4xl mx-auto p-4 space-y-4">
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border-t-4 border-blue-500">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-lg md:text-xl font-bold text-gray-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Batch)</h1>
                <span class="text-xs bg-gray-100 px-2 py-1 rounded-full text-gray-500">v3.19 Fast Entry</span>
            </div>
            
            <form id="productionForm" class="space-y-4">
                <!-- Common Header: Date, Shift, Time, Recorder -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-blue-800 mb-1">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)</label>
                        <input type="date" id="productionDate" name="productionDate" required class="w-full p-2 border border-blue-200 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-blue-800 mb-1">üë§ ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Recorder)</label>
                        <select id="recorder" name="recorder" required class="w-full p-2 border border-blue-200 rounded text-sm"></select>
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-blue-800 mb-1">‡∏Å‡∏∞ (Shift)</label>
                         <div class="flex items-center gap-2">
                            <select id="shift" name="shift" required class="w-20 p-2 border border-blue-200 rounded text-sm">
                                <option value="A">A</option>
                                <option value="B">B</option>
                            </select>
                            <div class="flex flex-col text-[10px]">
                                <label><input type="radio" name="shift_type_toggle" value="Day" onclick="updateHourSlots('Day')"> ‡πÄ‡∏ä‡πâ‡∏≤</label>
                                <label><input type="radio" name="shift_type_toggle" value="Night" onclick="updateHourSlots('Night')"> ‡∏î‡∏∂‡∏Å</label>
                            </div>
                         </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-blue-800 mb-1">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Time)</label>
                        <select id="hourSlot" name="hourSlot" required class="w-full p-2 border border-blue-200 rounded text-sm"></select>
                    </div>
                </div>

                <!-- Batch Entry List -->
                <div class="space-y-3">
                    <div id="batchList" class="space-y-3">
                        <!-- Dynamic Rows will be added here -->
                    </div>

                    <button type="button" onclick="addBatchRow()" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 font-bold hover:border-blue-400 hover:text-blue-500 transition-colors">
                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Add Model/Machine)
                    </button>
                </div>

                <hr class="border-gray-200">

                <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:from-blue-700 hover:to-indigo-700 active:scale-95 transition-transform duration-100 text-lg">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Save All)
                </button>
            </form>
        </div>
    </main>

    <!-- SECTION 2: PLANNING FORM -->
    <main id="section-planning" class="max-w-2xl mx-auto p-4 space-y-4 hidden">
        <!-- (Same as v3.17) -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border-t-4 border-indigo-500">
            <h1 class="text-lg font-bold text-gray-800 mb-4">üìÖ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h1>
            <form id="planningForm" class="space-y-4">
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 grid gap-4">
                    <input type="date" id="planDate" name="planDate" required class="w-full p-3 border rounded-lg">
                    <select id="planProduct" name="planProduct" required class="w-full p-3 border rounded-lg"></select>
                    <div class="grid grid-cols-2 gap-4">
                         <select id="planShift" name="planShift" class="p-3 border rounded-lg">
                             <option value="All">All Shifts</option><option value="A">A</option><option value="B">B</option>
                         </select>
                         <input type="number" id="planQty" name="planQty" placeholder="Target Qty" class="p-3 border rounded-lg text-center font-bold">
                    </div>
                </div>
                <button type="submit" id="planSubmitBtn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô</button>
            </form>
        </div>
    </main>

    <!-- SECTION 3: DASHBOARD -->
    <main id="section-dashboard" class="max-w-6xl mx-auto p-4 space-y-6 hidden">
        <!-- (Same as v3.17 Dashboard with Filters & Charts) -->
        <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-indigo-500">
            <h2 class="text-gray-700 font-bold text-sm mb-3">üìÖ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</h2>
            <div class="flex flex-col md:flex-row gap-3 items-end">
                <input type="date" id="startDate" class="w-full md:w-auto p-2 border rounded text-sm">
                <input type="date" id="endDate" class="w-full md:w-auto p-2 border rounded text-sm">
                <select id="filterShift" class="w-full md:w-auto p-2 border rounded text-sm"><option value="All">All Shift</option><option value="A">A</option><option value="B">B</option></select>
                <select id="filterShiftType" class="w-full md:w-auto p-2 border rounded text-sm"><option value="All">All Type</option><option value="Day">Day</option><option value="Night">Night</option></select>
                <button onclick="loadDashboard()" class="w-full md:w-auto bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>
        </div>

        <div id="dashboard-loader" class="hidden text-center py-10"><div class="loader mx-auto"></div></div>

        <div id="dashboard-content" class="space-y-6 pb-20">
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="widget-card p-4 border-l-4 border-indigo-500">
                    <p class="text-xs text-gray-400 font-bold">TARGET (PLAN)</p>
                    <p id="stat-target" class="text-2xl font-bold text-indigo-600">0</p>
                </div>
                <div class="widget-card p-4 border-l-4 border-blue-500">
                    <p class="text-xs text-gray-400 font-bold">TOTAL FG</p>
                    <p id="stat-fg" class="text-2xl font-bold text-blue-600">0</p>
                </div>
                <div class="widget-card p-4 border-l-4 border-orange-500">
                    <p class="text-xs text-gray-400 font-bold">% ACH</p>
                    <p id="stat-achievement" class="text-2xl font-bold text-orange-600">0%</p>
                </div>
                <div class="widget-card p-4 border-l-4 border-red-500">
                    <p class="text-xs text-gray-400 font-bold">TOTAL NG</p>
                    <p id="stat-ng" class="text-2xl font-bold text-red-600">0</p>
                </div>
                <div class="widget-card p-4 border-l-4 border-green-500">
                    <p class="text-xs text-gray-400 font-bold">% YIELD</p>
                    <p id="stat-yield" class="text-2xl font-bold text-green-600">0%</p>
                </div>
                <div class="widget-card p-4 border-l-4 border-teal-500">
                    <p class="text-xs text-gray-400 font-bold">UPH</p>
                    <p id="stat-uph" class="text-2xl font-bold text-teal-600">0</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="widget-card p-4 h-80"><canvas id="paretoChart"></canvas></div>
                <div class="widget-card p-4 h-80"><canvas id="qcTrendChart"></canvas></div>
                <div class="widget-card p-4 h-64"><canvas id="yieldModelChart"></canvas></div>
                <div class="widget-card p-4 h-64"><canvas id="yieldMachineChart"></canvas></div>
                <div class="widget-card p-4 h-80"><canvas id="hourlyChart"></canvas></div>
                <div class="widget-card p-4 h-80"><canvas id="ngChart"></canvas></div>
                <div class="widget-card md:col-span-2 p-4">
                    <div class="table-container">
                        <table class="w-full min-w-[1200px] divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr id="table-header"><th>Machine</th><th>FG</th><th>NG</th><th>% Yield</th></tr></thead>
                            <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- NG MODAL (Template) -->
    <div id="modal-ng" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-4">
            <h3 class="text-lg font-bold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ (NG)</h3>
            <div id="modal-ng-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
            <div class="flex gap-2">
                <button onclick="closeNgModal(true)" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button onclick="closeNgModal(false)" class="flex-1 bg-gray-200 py-2 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyt3Bf_2h21BBcCHQSjizowy_kD5vsoUqgaC_YmVjLuQybJO1BBRt3eaSM0PuKEFfvruw/exec";
        
        let ngSymptoms = ["‡∏•‡∏ß‡∏î‡∏ñ‡∏•‡∏≠‡∏Å (Scratched)", "‡∏û‡∏±‡∏ô‡∏´‡∏•‡∏ß‡∏° (Loose)", "‡∏£‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (Turn Error)", "‡∏Ç‡∏≤‡∏ú‡∏¥‡∏î‡∏£‡∏π‡∏õ (Lead Deform)", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Others)"];
        let recorderList = ["‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 1", "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 2"];
        let productList = ["S1B29288-JR (10A)", "S1B71819-JR (16A)", "S1B29292-JR (20A)", "51207080HC-JR (25/32A)"];
        
        // Configuration
        const DAY_HOURS = ["08:00-09:00", "09:00-10:00", "10:00-11:00", "11:00-12:00", "12:00-13:00", "13:00-14:00", "14:00-15:00", "15:00-16:00", "16:00-17:00", "OT 17:30-18:00", "OT 18:00-19:00", "OT 19:00-20:00"];
        const NIGHT_HOURS = ["20:00-21:00", "21:00-22:00", "22:00-23:00", "23:00-00:00", "00:00-01:00", "01:00-02:00", "02:00-03:00", "03:00-04:00", "04:00-05:00", "OT 05:00-06:30", "OT 06:00-07:30", "OT 07:00-08:00"];

        // State for NG data per row
        let currentRowIdForNg = null;
        let batchNgData = {}; // { rowId: [ {type, qty, remark} ] }
        let charts = {};

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('productionDate').value = today;
            document.getElementById('planDate').value = today;
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;

            if(localStorage.getItem('CWM_CUSTOM_NG')) ngSymptoms = JSON.parse(localStorage.getItem('CWM_CUSTOM_NG'));
            if(localStorage.getItem('CWM_RECORDERS')) recorderList = JSON.parse(localStorage.getItem('CWM_RECORDERS'));

            renderRecorderOptions();
            renderProductOptions();
            detectCurrentShift();
            addBatchRow(); // Start with one row

            if(window.location.hash === '#dashboard') switchTab('dashboard');
            else switchTab('form');
        };

        // --- Common Logic ---
        function detectCurrentShift() {
            const hour = new Date().getHours();
            let type = (hour >= 8 && hour < 20) ? "Day" : "Night";
            document.querySelector(`input[name="shift_type_toggle"][value="${type}"]`).checked = true;
            updateHourSlots(type);
        }
        function updateHourSlots(type) {
            const select = document.getElementById('hourSlot');
            const hours = (type === "Day") ? DAY_HOURS : NIGHT_HOURS;
            select.innerHTML = hours.map(h => `<option value="${h}">${h}</option>`).join('');
            const currentHourStr = new Date().getHours().toString().padStart(2, '0') + ":00";
            const match = hours.find(h => h.startsWith(currentHourStr));
            if(match) select.value = match;
        }

        function switchTab(tab) {
            ['form', 'planning', 'dashboard'].forEach(t => {
                document.getElementById('section-'+t).classList.toggle('hidden', t !== tab);
                const btn = document.getElementById('tab-'+t);
                if(t === tab) { btn.classList.add('tab-active','text-blue-600'); btn.classList.remove('text-gray-500'); }
                else { btn.classList.remove('tab-active','text-blue-600'); btn.classList.add('text-gray-500'); }
            });
            if(tab === 'dashboard') loadDashboard();
        }

        // --- Batch Row Logic ---
        function addBatchRow() {
            const container = document.getElementById('batchList');
            const rowId = 'row-' + Date.now() + Math.random().toString(36).substr(2, 5);
            
            // Default Machine Options
            let machineOpts = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á...</option>';
            for(let i=1; i<=16; i++) machineOpts += `<option value="CWM-${String(i).padStart(2,'0')}">CWM-${String(i).padStart(2,'0')}</option>`;
            
            // Product Options
            let prodOpts = productList.map(p => `<option value="${p}">${p}</option>`).join('');

            const div = document.createElement('div');
            div.id = rowId;
            div.className = "bg-white p-3 border border-gray-200 rounded-lg shadow-sm animate-fade-in flex flex-col md:flex-row gap-3 items-end md:items-center";
            div.innerHTML = `
                <div class="flex-1 w-full">
                    <label class="text-[10px] text-gray-400 font-bold uppercase">Machine</label>
                    <select name="machine" class="w-full p-2 border rounded bg-gray-50 text-sm font-bold">${machineOpts}</select>
                </div>
                <div class="flex-1 w-full">
                    <label class="text-[10px] text-gray-400 font-bold uppercase">Product</label>
                    <select name="productCode" class="w-full p-2 border rounded bg-gray-50 text-sm">${prodOpts}</select>
                </div>
                <div class="w-24">
                    <label class="text-[10px] text-gray-400 font-bold uppercase">FG (‡∏î‡∏µ)</label>
                    <input type="number" name="fgAmount" value="1000" class="w-full p-2 border rounded text-center font-bold text-green-600 bg-green-50 focus:bg-white" min="0">
                </div>
                <div class="w-full md:w-auto flex gap-2">
                    <button type="button" onclick="openNgModal('${rowId}')" class="flex-1 md:flex-none bg-red-50 text-red-600 border border-red-200 px-3 py-2 rounded font-bold text-sm hover:bg-red-100 relative">
                        NG <span id="ng-badge-${rowId}" class="hidden absolute -top-2 -right-2 bg-red-600 text-white text-[10px] px-1.5 py-0.5 rounded-full">0</span>
                    </button>
                    <button type="button" onclick="removeBatchRow('${rowId}')" class="text-gray-400 hover:text-red-500 px-2 text-xl">&times;</button>
                </div>
            `;
            container.appendChild(div);
            // Init empty NG data for this row
            batchNgData[rowId] = [];
        }

        function removeBatchRow(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
            delete batchNgData[id];
        }

        // --- NG Modal Logic ---
        function openNgModal(rowId) {
            currentRowIdForNg = rowId;
            const modal = document.getElementById('modal-ng');
            const list = document.getElementById('modal-ng-list');
            list.innerHTML = '';
            
            // Create inputs for each symptom
            ngSymptoms.forEach(s => {
                // Check if value exists
                const existing = batchNgData[rowId].find(x => x.type === s);
                const val = existing ? existing.qty : '';
                const remark = existing ? existing.remark : '';
                
                list.innerHTML += `
                    <div class="border-b pb-2 mb-2">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-700">${s}</span>
                            <input type="number" class="ng-input-qty w-20 p-1 border rounded text-right" data-type="${s}" value="${val}" placeholder="0" min="0">
                        </div>
                        <input type="text" class="ng-input-remark w-full p-1 border rounded text-xs bg-gray-50" data-type="${s}" value="${remark}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">
                    </div>
                `;
            });
            modal.classList.remove('hidden');
        }

        function closeNgModal(save) {
            if(save && currentRowIdForNg) {
                const inputs = document.querySelectorAll('.ng-input-qty');
                const remarks = document.querySelectorAll('.ng-input-remark');
                const newData = [];
                let total = 0;
                
                inputs.forEach((input, index) => {
                    const qty = parseInt(input.value);
                    if(qty > 0) {
                        newData.push({
                            type: input.dataset.type,
                            qty: qty,
                            remark: remarks[index].value
                        });
                        total += qty;
                    }
                });
                
                batchNgData[currentRowIdForNg] = newData;
                
                // Update badge
                const badge = document.getElementById(`ng-badge-${currentRowIdForNg}`);
                if(total > 0) {
                    badge.innerText = total;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
            document.getElementById('modal-ng').classList.add('hidden');
            currentRowIdForNg = null;
        }

        // --- Submit Batch ---
        document.getElementById('productionForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn'); const txt = btn.innerText;
            btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            
            // Common Data
            const fd = new FormData(e.target);
            const shiftType = document.querySelector('input[name="shift_type_toggle"]:checked').value;
            const common = {
                timestamp: new Date().toLocaleString('th-TH'),
                productionDate: fd.get('productionDate'),
                shift: fd.get('shift'),
                shiftType: shiftType,
                recorder: fd.get('recorder'),
                hourSlot: fd.get('hourSlot')
            };

            // Gather Items
            const items = [];
            const rowDivs = document.getElementById('batchList').children;
            for(let div of rowDivs) {
                const machine = div.querySelector('[name="machine"]').value;
                const product = div.querySelector('[name="productCode"]').value;
                const fg = parseInt(div.querySelector('[name="fgAmount"]').value) || 0;
                
                if(!machine) continue; // Skip empty machine selection
                
                items.push({
                    machine: machine,
                    productCode: product,
                    fgAmount: fg,
                    ngDetails: batchNgData[div.id] || []
                });
            }

            if(items.length === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
                btn.disabled = false; btn.innerText = txt;
                return;
            }

            const payload = {
                action: 'SAVE_BATCH_PRODUCTION',
                common: common,
                items: items
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                // Reset Grid
                document.getElementById('batchList').innerHTML = '';
                batchNgData = {};
                addBatchRow();
            } catch(e) {
                alert("Error: " + e.message);
            } finally {
                btn.disabled = false; btn.innerText = txt;
            }
        };

        // --- Other Helpers (Same as before) ---
        function renderRecorderOptions() { 
            const s = document.getElementById('recorder'); 
            s.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>' + recorderList.map(r=>`<option value="${r}">${r}</option>`).join(''); 
        }
        function renderProductOptions() {
            const s = document.getElementById('planProduct');
            if(s) s.innerHTML = productList.map(p=>`<option value="${p}">${p}</option>`).join('');
        }
        function manageRecorders() {
             const p = prompt("‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma):", recorderList.join(','));
             if(p) {
                 recorderList = p.split(',').map(x=>x.trim()).filter(x=>x);
                 localStorage.setItem('CWM_RECORDERS', JSON.stringify(recorderList));
                 renderRecorderOptions();
             }
        }
        
        // Planning Submit
        document.getElementById('planningForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = {
                action: 'SAVE_PLAN', planDate: fd.get('planDate'), product: fd.get('planProduct'),
                shift: fd.get('planShift'), qty: fd.get('planQty')
            };
            await fetch(SCRIPT_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(payload)});
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); e.target.reset();
        };

        // Dashboard logic (Keep existing loadDashboard, renderCharts, etc.)
        // ... (Include all dashboard functions from previous version here) ...
        async function loadDashboard() {
            if(!SCRIPT_URL) return;
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('dashboard-loader').classList.remove('hidden');
            const start = document.getElementById('startDate').value; const end = document.getElementById('endDate').value;
            const shift = document.getElementById('filterShift').value; const shiftType = document.getElementById('filterShiftType').value;
            try {
                const res = await fetch(`${SCRIPT_URL}?action=GET_DASHBOARD&start=${start}&end=${end}&shift=${shift}&shiftType=${shiftType}`);
                const data = await res.json();
                document.getElementById('stat-fg').innerText = data.totalFg.toLocaleString();
                document.getElementById('stat-ng').innerText = data.totalNg.toLocaleString();
                document.getElementById('stat-target').innerText = (data.productionTarget||0).toLocaleString();
                const ach = data.productionTarget>0 ? ((data.totalFg/data.productionTarget)*100).toFixed(1) : 0;
                document.getElementById('stat-achievement').innerText = ach+"%";
                document.getElementById('progress-achievement').style.width = Math.min(ach,100)+"%";
                const total = data.totalFg + data.totalNg;
                const yieldVal = total>0?((data.totalFg/total)*100).toFixed(2):0;
                document.getElementById('stat-yield').innerText = yieldVal+"%";
                
                renderCharts(data);
                renderTable(data);
            } catch(e) { console.error(e); } 
            finally { document.getElementById('dashboard-loader').classList.add('hidden'); document.getElementById('dashboard-content').classList.remove('hidden'); }
        }
        
        // ... (Charts and Table functions are same as v3.16) ...
        function renderCharts(data) {
             // ... copy existing renderCharts logic ...
             // Just ensuring charts object is defined
             if(!charts) charts = {}; 
             // Simple placeholder to ensure it runs without error if you copy paste full block
             const ctxP = document.getElementById('paretoChart');
             if(ctxP) {
                 if(charts.pareto) charts.pareto.destroy();
                 charts.pareto = new Chart(ctxP, { type: 'bar', data: { labels:[], datasets:[] } }); // Minimal init
                 // Real logic is in previous response
             }
        }
        function renderTable(data) {
            const b = document.getElementById('table-body'); b.innerHTML = '';
            // ... copy existing renderTable logic ...
        }
    </script>
</body>
</html>
